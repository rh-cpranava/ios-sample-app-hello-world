---
- name: Build iOS Simulator app on macOS and emit artifact paths
  hosts: mac
  gather_facts: true
  vars:
    remote_base: "{{ remote_base | default(ansible_env.HOME ~ '/tekton-workdir') }}"
    remote_src: "{{ remote_base }}/src"
    project_relpath: "{{ project_relpath | default('.') }}"
    xcode_project: "{{ xcode_project | default('hello-world.xcodeproj') }}"
    scheme: "{{ scheme | default('hello-world') }}"
    destination: "{{ destination | default('platform=iOS Simulator,name=iPhone 16e') }}"

  tasks:
    - name: Show Xcode version
      ansible.builtin.command: xcodebuild -version
      changed_when: false

    - name: "Delete location {{ remote_base }}/out"
      ansible.builtin.file:
        path: "{{ remote_base }}/out"
        state: absent

    - name: "Recreate location {{ remote_base }}/out"
      ansible.builtin.file:
        path: "{{ remote_base }}/out"
        state: directory

    - name: Build (Simulator, no signing) and write result bundle
      ansible.builtin.shell: |
        set -euo pipefail
        xcodebuild \
          -project "{{ xcode_project }}" \
          -scheme "{{ scheme }}" \
          -destination '{{ destination }}' \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_IDENTITY="" \
          -resultBundlePath "{{ remote_base }}/out/{{ scheme }}.xcresult" \
          build
      args:
        chdir: "{{ remote_src }}/{{ project_relpath }}"
        executable: /bin/bash

    - name: Find built .app under DerivedData (iphonesimulator)
      ansible.builtin.shell: |
        set -euo pipefail
        APP_PATH="$(find "$HOME/Library/Developer/Xcode/DerivedData" -type d -name "*.app" \
          | grep -E "/Build/Products/.*-iphonesimulator/" \
          | head -n 1 || true)"

        if [ -z "$APP_PATH" ]; then
          echo "ERROR: Could not locate .app under DerivedData." >&2
          exit 2
        fi

        echo "$APP_PATH"
      args:
        executable: /bin/bash
      register: app_path
      changed_when: false

    - name: Get remote HOME
      ansible.builtin.command: /bin/bash -lc 'echo $HOME'
      register: home_out
      changed_when: false

    - name: Set artifact vars
      ansible.builtin.set_fact:
        artifact_app_path: "{{ app_path.stdout }}"
        artifact_xcresult_path: "{{ home_out.stdout }}/out/{{ scheme }}.xcresult"

    - name: Print artifact paths (machine readable for Tekton parsing)
      ansible.builtin.debug:
        msg:
          - "APP_PATH={{ artifact_app_path }}"
          - "XCRESULT_PATH={{ artifact_xcresult_path }}"
